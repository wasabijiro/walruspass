# WalrusPass

## What It Does  
**WalrusPass** は、コンテンツクリエイターが音楽や動画などの限定コンテンツを、特定の NFT を保有するユーザーのみが閲覧できる仕組み（NFT をゲートとして利用する仕組み）を実現する分散型プラットフォームです。
- **限定コンテンツの暗号化アップロード:**  
  Walrus上に、画像や動画などの限定コンテンツをエンドツーエンドで暗号化してアップロードするのだ。
  
- **NFT所有者のみ復号可能:**  
  NFTがmintされると、その所有者だけが専用の復号鍵を利用して暗号化されたコンテンツを閲覧できる仕組みなのだ。
  
- **クリエイターとユーザー間の信頼性の高いエコシステム:**
  コンテンツ所有権をブロックチェーン上のNFTに紐付け、NFT保有者にのみ限定コンテンツのアクセス権を自動付与することで、信頼性の高い関係を構築するのだ。

- **ユースケース**
  ミュージシャンがアルバムやライブ映像、映像クリエイターが限定映像を提供、オンライン講座でのプレミアム動画公開など、NFT 保有者限定の体験を実現するために利用する。

---

## The Problem It Solves  

Walrus の分散型ストレージは、その検閲耐性や耐障害性により、中央サーバーに依存しないデータ管理が可能であり、ユーザー自身がデジタル資産を分散ネットワーク上に保存することで、真の所有権を確保できるという大きなメリットがあります。しかし、その一方で、分散型ストレージはプライベートデータの取り扱いが難しいという欠点も抱えています。具体的には、データの暗号化・復号のプロセスや、誰がどのデータにアクセスできるかを厳密に管理するアクセス制御の実装が困難であるため、プライベートな情報を安全に秘匿する仕組みを整えるのが容易ではありません。
この課題は、NFT を用いたトークンゲートウェイの実装においても顕著に現れます。NFT のトークンゲートウェイでは、限定コンテンツへのアクセスを NFT 所有者にのみ許可する必要があります。つまり、ユーザーが NFT を所有しているかどうかを厳密に確認し、所有者だけが暗号化されたコンテンツの復号鍵を取得できる仕組みが求められます。しかし、分散型ストレージ自体がプライベートデータの取り扱いに苦戦しているため、NFT 所有者に限定してコンテンツを提供するというユースケースは、設計上の大きなハードルとなります。なのでこのような実装を行う場合、AWSなどのクラウドストレージのような中央集権的なストレージにデジタルアセットが保存されてしまい、分散型ストレージの強みを活かせません。

---

## The Solution – Tuskyの暗号化と鍵管理  
Tuskyはエンドツーエンドでデータを暗号化する仕組みを提供しており、ユーザーとVaultの鍵管理によって、限定アクセスを実現します。

- **クライアント側の鍵ペア生成:**  
  ユーザーはTusky Login時に、フロントエンド上で自身のユーザー鍵ペアを生成します。  
  - **ユーザー公開鍵:** これをサーバーやVaultの共有処理に利用します。  
  - **ユーザー秘密鍵:** ユーザーが入力するパスワードやバックアップフレーズから導出した鍵で暗号化し、暗号化状態でサーバーに保存します。  

- **Vault作成時の鍵生成と共有:**  
  出品者（Vault所有者）は、自身のVaultを作成する際に、Vault専用の鍵ペアを生成します。  
  - Vaultの**公開鍵**は、Vault内のコンテンツの暗号化に用いられ、復号はVaultの**秘密鍵**が必要です。  
  - 出品者は、購入者（NFT所有者）にVaultへのアクセス権を与える際、出品者のバックエンドが保持する認証情報を使い、Vault秘密鍵を購入者のユーザー公開鍵で暗号化して共有します。  
  - これにより、購入者は自分のユーザー秘密鍵を用いてVault秘密鍵を復号し、限定コンテンツの復号に必要な鍵を取得できます。

- **セキュリティの徹底:**  
  出品者の認証情報（APIキーなど）はバックエンドで安全に管理し、フロントエンドには一切渡さず、必要なタイミングでのみ利用します。  
  さらに、将来的にはSeal暗号化スキームなど、トークン制限付きでプライベートボールトへのアクセスを強化する仕組みも予定されています。

---

### Challenges I Ran Into

- **オンチェーンとオフチェーンの連携:**  
  NFT mint イベントの検知と、それに基づいた自動的なVault共有処理の連動は非常に技術的なチャレンジでした。Tusky SDK の仕様に依存すると、スマートコントラクトのイベントから鍵配送問題にぶつかるケースがあり、イベントを正確にキャッチしてオフチェーンの権限付与処理へ反映する設計が難航しました。

- **認証情報の管理:**  
  出品者のAPIキーなどの認証情報をバックエンドで安全に管理する方法を模索しました。実際のデモでは、出品者の認証情報をバックエンドに保持する形でVaultの共有操作を自動化しましたが、この方法は完全な分散性を損ねる可能性があり、より分散型な認証方法（たとえばLit Protocolの活用や、SEAL暗号化スキームのアップデート）への改善が求められます。

---

## Technologies I Used
- **Sui Move:**
  - NFT の mint、所有権管理、イベント発火  
  - Sui Move でのスマートコントラクト実装
- **Walrus**
  - 分散型ストレージネットワーク
  - 暗号化されたコンテンツの保管
- **Tusky SDK / API**
  - ユーザー認証、Vault の管理、ファイルアップロード・ダウンロード  
  - Vault 共有機能
- **Next.js**  
  - フロントエンド
  - バックエンド（API ルート）
- **Supabase**  
  - DB

---

## How We Built It  
1. **スマートコントラクトの実装:**  
   - Sui Moveを用いてNFT mintのスマートコントラクトを開発し、mint時にイベント（例：Minted）を発火。

2. **クライアント側の鍵管理:**  
   - Tusky SDKを組み込み、ユーザーはログイン時に自身のユーザー鍵ペアを生成。  
   - ユーザー秘密鍵は、ユーザーのパスワードから導出された鍵で暗号化し、暗号化された状態で保存。  
   - Vault作成時に、出品者は新たなVault鍵ペアを生成し、Vault秘密鍵を購入者のユーザー公開鍵で暗号化して共有する。

3. **フロントエンド統合:**  
   - ReactやNext.jsなどを用いて、ユーザーが簡単にコンテンツのアップロード、Vault管理、限定コンテンツへのアクセスを行えるUIを実装。

---

## What We Learned  
- **オンチェーン・オフチェーン連携の重要性:**  
  NFT mint イベントとオフチェーンでの自動権限付与処理の連携は、実装と運用の両面で非常にチャレンジングであると実感。  
- **分散型認証と鍵管理:**  
  ユーザー自身がデータの暗号化とアクセス権管理を行うための鍵管理の仕組みの重要性と、その難しさを学びました。  
- **分散型ストレージの可能性:**  
  WalrusやTusky APIを活用することで、中央集権型サービスに依存しない新しいデジタル資産管理の形が実現できると確信。

---

## What's Next For  
- **スマートコントラクト連携の改善:**  
  NFT mint イベントの検知精度向上と、よりセキュアなオフチェーンリレーサービスの構築。  
- **委任署名の検討:**
  出品者の認証情報を直接バックエンドに保存せず、分散型で管理する仕組みの検討。  
- **新たなユースケースの展開:**  
  - **限定公開可能な分散型YouTube** 限定公開コンテンツも含め分散型ストレージに保存
  - **分散型サプライチェーン管理:** 商品の移動履歴や品質検査データをリアルタイムで共有  
  - **分散型医療データ共有:** 患者の医療データを安全に保存・共有し、診断・治療の質向上を支援  
  - **メディアサブスクリプションモデル:** クリエイターが限定コンテンツの解読鍵を支払い済みユーザーに提供

さらに、Tuskyは近日中にSeal暗号化スキームを導入し、トークン制限付きでプライベートボールトへのアクセスを提供予定です。これにより、NFT所有者専用のプライベートデータアクセス制御がさらに強化される展望があります。
